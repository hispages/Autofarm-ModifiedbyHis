-- SIMPLE SERVER HOP SYSTEM - DEBUG VERSION
-- Letakkan di ServerScriptService

local TeleportService = game:GetService("TeleportService")
local Players = game:GetService("Players")
local HttpService = game:GetService("HttpService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

-- ===== BASIC CONFIGURATION =====
local PLACE_ID = game.PlaceId
local MAX_PLAYERS = 8
local MIN_PLAYERS = 1
local COOLDOWN_TIME = 60

print("üöÄ Server Hop System Loading...")
print("Place ID: " .. PLACE_ID)

-- ===== SIMPLE VARIABLES =====
local hopCooldowns = {}
local isSystemActive = true

-- ===== BASIC FUNCTIONS =====

-- Function untuk teleport player (paling basic)
local function teleportPlayer(player, serverId)
    print("üîÑ Attempting teleport for: " .. player.Name)
    
    local success, error = pcall(function()
        if serverId then
            print("üìç Teleporting to specific server: " .. serverId)
            TeleportService:TeleportToPlaceInstance(PLACE_ID, serverId, player)
        else
            print("üé≤ Teleporting to random server")
            TeleportService:Teleport(PLACE_ID, player)
        end
    end)
    
    if not success then
        warn("‚ùå Teleport failed: " .. tostring(error))
        return false
    end
    
    print("‚úÖ Teleport initiated successfully")
    return true
end

-- Function untuk cek cooldown
local function checkCooldown(player)
    local userId = player.UserId
    local currentTime = tick()
    
    if hopCooldowns[userId] then
        local timePassed = currentTime - hopCooldowns[userId]
        if timePassed < COOLDOWN_TIME then
            local remaining = COOLDOWN_TIME - timePassed
            print("‚è∞ " .. player.Name .. " masih cooldown: " .. math.ceil(remaining) .. "s")
            return false, remaining
        end
    end
    
    hopCooldowns[userId] = currentTime
    return true, 0
end

-- Function untuk hop ke random server (paling simple)
local function hopToRandomServer(player)
    print("üéØ " .. player.Name .. " meminta random server hop")
    
    local canHop, cooldownRemaining = checkCooldown(player)
    if not canHop then
        -- Kick dengan pesan cooldown
        player:Kick("Server hop cooldown: " .. math.ceil(cooldownRemaining) .. " detik lagi!")
        return
    end
    
    -- Langsung teleport random
    teleportPlayer(player, nil)
end

-- Function untuk hop ke server sepi
local function hopToEmptyServer(player)
    print("üìâ " .. player.Name .. " meminta server sepi")
    
    local canHop, cooldownRemaining = checkCooldown(player)
    if not canHop then
        player:Kick("Server hop cooldown: " .. math.ceil(cooldownRemaining) .. " detik lagi!")
        return
    end
    
    -- Coba ambil server list
    local success, serverData = pcall(function()
        local url = "https://games.roblox.com/v1/games/" .. PLACE_ID .. "/servers/Public?sortOrder=Asc&limit=10"
        local response = HttpService:GetAsync(url)
        return HttpService:JSONDecode(response)
    end)
    
    if success and serverData and serverData.data then
        print("üìä Dapat " .. #serverData.data .. " servers")
        
        -- Cari server dengan player paling sedikit
        local bestServer = nil
        local lowestCount = 999
        
        for _, server in pairs(serverData.data) do
            if server.id ~= game.JobId and -- Bukan server ini
               server.playing >= MIN_PLAYERS and -- Ada minimal player
               server.playing < MAX_PLAYERS and -- Tidak penuh
               server.playing < lowestCount then -- Player paling sedikit
                
                bestServer = server
                lowestCount = server.playing
            end
        end
        
        if bestServer then
            print("üéØ Found server dengan " .. bestServer.playing .. " players")
            teleportPlayer(player, bestServer.id)
        else
            print("‚ùå Tidak ada server yang cocok, random teleport")
            teleportPlayer(player, nil)
        end
    else
        warn("‚ùå Gagal ambil server list, random teleport")
        teleportPlayer(player, nil)
    end
end

-- ===== SIMPLE GUI =====
local function createSimpleGUI(player)
    print("üé® Creating GUI for: " .. player.Name)
    
    local playerGui = player:WaitForChild("PlayerGui")
    
    -- Hapus GUI lama jika ada
    local oldGUI = playerGui:FindFirstChild("ServerHopGUI")
    if oldGUI then
        oldGUI:Destroy()
    end
    
    -- Buat GUI baru
    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "ServerHopGUI"
    screenGui.ResetOnSpawn = false
    screenGui.Parent = playerGui
    
    -- Frame utama
    local mainFrame = Instance.new("Frame")
    mainFrame.Size = UDim2.new(0, 250, 0, 150)
    mainFrame.Position = UDim2.new(1, -270, 0, 20)
    mainFrame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    mainFrame.Parent = screenGui
    
    -- Corner
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 8)
    corner.Parent = mainFrame
    
    -- Title
    local title = Instance.new("TextLabel")
    title.Size = UDim2.new(1, 0, 0, 30)
    title.BackgroundTransparency = 1
    title.Text = "SERVER HOP"
    title.TextColor3 = Color3.fromRGB(255, 255, 255)
    title.TextScaled = true
    title.Font = Enum.Font.SourceSansBold
    title.Parent = mainFrame
    
    -- Button 1: Random
    local randomBtn = Instance.new("TextButton")
    randomBtn.Size = UDim2.new(0.9, 0, 0, 30)
    randomBtn.Position = UDim2.new(0.05, 0, 0, 40)
    randomBtn.Text = "Random Server"
    randomBtn.BackgroundColor3 = Color3.fromRGB(0, 120, 215)
    randomBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
    randomBtn.Font = Enum.Font.SourceSans
    randomBtn.TextScaled = true
    randomBtn.Parent = mainFrame
    
    local randomCorner = Instance.new("UICorner")
    randomCorner.Parent = randomBtn
    
    -- Button 2: Empty Server
    local emptyBtn = Instance.new("TextButton")
    emptyBtn.Size = UDim2.new(0.9, 0, 0, 30)
    emptyBtn.Position = UDim2.new(0.05, 0, 0, 80)
    emptyBtn.Text = "Server Sepi"
    emptyBtn.BackgroundColor3 = Color3.fromRGB(0, 150, 0)
    emptyBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
    emptyBtn.Font = Enum.Font.SourceSans
    emptyBtn.TextScaled = true
    emptyBtn.Parent = mainFrame
    
    local emptyCorner = Instance.new("UICorner")
    emptyCorner.Parent = emptyBtn
    
    -- Info Label
    local infoLabel = Instance.new("TextLabel")
    infoLabel.Size = UDim2.new(1, 0, 0, 20)
    infoLabel.Position = UDim2.new(0, 0, 0, 120)
    infoLabel.BackgroundTransparency = 1
    infoLabel.Text = "Players: " .. #Players:GetPlayers()
    infoLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
    infoLabel.TextScaled = true
    infoLabel.Font = Enum.Font.SourceSans
    infoLabel.Parent = mainFrame
    
    -- Button Events
    randomBtn.MouseButton1Click:Connect(function()
        print("üé≤ " .. player.Name .. " clicked Random Server")
        hopToRandomServer(player)
    end)
    
    emptyBtn.MouseButton1Click:Connect(function()
        print("üìâ " .. player.Name .. " clicked Server Sepi")
        hopToEmptyServer(player)
    end)
    
    -- Update player count
    spawn(function()
        while screenGui.Parent and screenGui.Parent.Parent do
            wait(5)
            if infoLabel and infoLabel.Parent then
                infoLabel.Text = "Players: " .. #Players:GetPlayers()
            else
                break
            end
        end
    end)
    
    print("‚úÖ GUI created successfully for: " .. player.Name)
end

-- ===== SIMPLE CHAT COMMANDS =====
local function onPlayerChatted(player, message)
    local msg = string.lower(message)
    
    if msg == "/hop" or msg == "/serverhop" then
        print("üí¨ " .. player.Name .. " used chat command: " .. message)
        hopToRandomServer(player)
    elseif msg == "/hopempty" then
        print("üí¨ " .. player.Name .. " used chat command: " .. message)
        hopToEmptyServer(player)
    elseif msg == "/serverinfo" then
        local info = "Server Players: " .. #Players:GetPlayers() .. "/" .. MAX_PLAYERS
        print("üìä Server info requested by " .. player.Name .. ": " .. info)
        -- Tidak ada notification system, jadi print saja
    end
end

-- ===== EVENTS =====
Players.PlayerAdded:Connect(function(player)
    print("üëã Player joined: " .. player.Name)
    
    -- Wait for player to load
    wait(3)
    
    -- Create GUI
    createSimpleGUI(player)
    
    -- Connect chat
    player.Chatted:Connect(function(message)
        onPlayerChatted(player, message)
    end)
    
    print("‚úÖ Setup complete for: " .. player.Name)
end)

Players.PlayerRemoving:Connect(function(player)
    print("üëã Player leaving: " .. player.Name)
    
    -- Cleanup cooldown
    if hopCooldowns[player.UserId] then
        hopCooldowns[player.UserId] = nil
    end
end)

-- ===== STARTUP =====
print("‚úÖ Server Hop System Loaded Successfully!")
print("üìã Commands: /hop, /hopempty, /serverinfo")
print("üéÆ GUI akan muncul untuk setiap player yang join")

-- Test HTTP Service
spawn(function()
    wait(5)
    local success = pcall(function()
        HttpService:GetAsync("https://httpbin.org/get")
    end)
    
    if success then
        print("‚úÖ HTTP Service Working!")
    else
        warn("‚ùå HTTP Service NOT enabled! Enable di Game Settings > Security > Allow HTTP Requests")
    end
end)